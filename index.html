<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('stylesheet'); ?>
  </head>
  <body>
    <div class="container">
      <h1>Task Manager</h1>

      <!-- Login Page -->
      <div id="loginPage" class="page">
        <h2>Login</h2>
        <div class="login-form">
          <input type="email" id="loginUsername" placeholder="Username (e.g., email)" required>
          <input type="password" id="loginPassword" placeholder="Password" required>
          <button id="loginBtn">Login</button>
          <p id="loginError" class="error-message"></p>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="dashboardPage" class="page hidden">
        <div class="dashboard-header">
          <h2 id="welcomeMessage">Welcome!</h2>
          <span id="userRoleDisplay" class="role-tag"></span>
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>

        <div class="summary-cards">
          <div class="card">Total Tasks: <span id="totalTasksCount">0</span></div>
          <div class="card to-do">To Do: <span id="toDoTasksCount">0</span></div>
          <div class="card done">Done: <span id="doneTasksCount">0</span></div>
        </div>

        <!-- Add New Task Form (visible to all, assign to dropdown only for Admin) -->
        <div class="task-form">
          <h2>Add New Task</h2>
          <input type="text" id="taskTitle" placeholder="New Task Title" required>
          <textarea id="taskDescription" placeholder="Description (optional)"></textarea>
          <div id="assignToContainer" class="hidden">
            <label for="assignTo">Assign To:</label>
            <select id="assignTo">
              <!-- Users will be loaded here for Admin -->
            </select>
          </div>
          <button id="addTaskBtn">Add Task</button>
          <p id="addTaskMessage" class="status-message"></p>
        </div>

        <!-- NEW: Assign Existing Task Form (Only visible to Admin) -->
        <div id="assignExistingTaskForm" class="task-form hidden">
            <h2>Reassign Existing Task</h2>
            <div id="assignExistingTaskContainer">
                <label for="selectTaskToAssign">Select Task:</label>
                <select id="selectTaskToAssign">
                    <!-- Tasks will be loaded here for Admin -->
                </select>
                <label for="assignExistingTo">Assign To Employee:</label>
                <select id="assignExistingTo">
                    <!-- Employees will be loaded here -->
                </select>
                <button id="assignExistingTaskBtn">Assign Task</button>
            </div>
            <p id="assignExistingTaskMessage" class="status-message"></p>
        </div>


        <div id="employeeTaskSections">
            <div class="task-list-container">
                <h2>Tasks You Created</h2>
                <ul id="createdTaskList">
                    <li class="loading">Loading tasks...</li>
                </ul>
            </div>
            <div class="task-list-container">
                <h2>Tasks Assigned To You</h2>
                <ul id="assignedTaskList">
                    <li class="loading">Loading tasks...</li>
                </ul>
            </div>
        </div>

        <div id="adminTaskSection" class="task-list-container hidden">
            <h2>All Tasks</h2>
            <ul id="allTaskList">
                <li class="loading">Loading tasks...</li>
            </ul>
        </div>
      </div>
    </div>

    <script>
      // --- Global UI Elements ---
      const loginPage = document.getElementById('loginPage');
      const dashboardPage = document.getElementById('dashboardPage');
      const loginUsernameInput = document.getElementById('loginUsername');
      const loginPasswordInput = document.getElementById('loginPassword');
      const loginBtn = document.getElementById('loginBtn');
      const loginError = document.getElementById('loginError');
      const logoutBtn = document.getElementById('logoutBtn');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const userRoleDisplay = document.getElementById('userRoleDisplay');
      const totalTasksCount = document.getElementById('totalTasksCount');
      const toDoTasksCount = document.getElementById('toDoTasksCount');
      const doneTasksCount = document.getElementById('doneTasksCount');
      const taskTitleInput = document.getElementById('taskTitle');
      const taskDescriptionInput = document.getElementById('taskDescription');
      const addTaskBtn = document.getElementById('addTaskBtn');
      const addTaskMessage = document.getElementById('addTaskMessage'); // Message for Add Task Form

      const assignToContainer = document.getElementById('assignToContainer');
      const assignToDropdown = document.getElementById('assignTo');

      const employeeTaskSections = document.getElementById('employeeTaskSections');
      const createdTaskList = document.getElementById('createdTaskList');
      const assignedTaskList = document.getElementById('assignedTaskList');
      const adminTaskSection = document.getElementById('adminTaskSection');
      const allTaskList = document.getElementById('allTaskList');

      // NEW Assign Existing Task elements
      const assignExistingTaskForm = document.getElementById('assignExistingTaskForm');
      const selectTaskToAssignDropdown = document.getElementById('selectTaskToAssign');
      const assignExistingToDropdown = document.getElementById('assignExistingTo');
      const assignExistingTaskBtn = document.getElementById('assignExistingTaskBtn');
      const assignExistingTaskMessage = document.getElementById('assignExistingTaskMessage'); // Message for Reassign Form


      // --- Client-Side State ---
      let currentUserId = null;
      let currentUserDisplayName = null;
      let currentUserRole = null;
      let allUsers = []; // Stores users for the 'assign to' dropdown
      let currentAdminTasks = []; // To populate "select task" for admin reassign

      // --- Page Switching ---
      function showPage(pageId) {
        loginPage.classList.add('hidden');
        dashboardPage.classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');
      }

      // --- Loading and Error Handlers ---
      function showLoading(isLoading, targetElement) {
        if (!targetElement) return; // Guard against null target
        if (isLoading) {
          targetElement.innerHTML = '<li class="loading">Loading...</li>';
          targetElement.setAttribute('aria-busy', 'true');
        } else {
          targetElement.removeAttribute('aria-busy');
          if (targetElement.querySelector('.loading')) {
            targetElement.innerHTML = ''; // Clear loading message if it exists
          }
        }
      }

      function handleServerSuccess(callback, ...args) {
        return function(result) {
          if (loginBtn) loginBtn.disabled = false;
          callback(result, ...args);
        };
      }

      function handleServerError(error, messageElement = loginError) {
        return function(errorMessage) {
          if (loginBtn) loginBtn.disabled = false;
          console.error('Server error:', errorMessage);
          const msg = errorMessage.message || errorMessage || 'Unknown error';
          alert('An error occurred: ' + msg);
          if (messageElement) {
              messageElement.textContent = msg;
              messageElement.classList.add('error-message');
              messageElement.classList.remove('success-message');
          }
        };
      }

      function showStatusMessage(messageElement, message, isSuccess) {
          messageElement.textContent = message;
          if (isSuccess) {
              messageElement.classList.remove('error-message');
              messageElement.classList.add('success-message');
          } else {
              messageElement.classList.remove('success-message');
              messageElement.classList.add('error-message');
          }
          setTimeout(() => messageElement.textContent = '', 5000); // Clear after 5 seconds
      }

      // --- Authentication Logic ---
      function checkLoginStatus() {
        currentUserId = localStorage.getItem('currentUserId');
        currentUserDisplayName = localStorage.getItem('currentUserDisplayName');
        currentUserRole = localStorage.getItem('currentUserRole');

        if (currentUserId && currentUserDisplayName && currentUserRole) {
          showDashboard();
        } else {
          showPage('loginPage');
        }
      }

      function handleLoginSuccess(user) {
        if (user) {
          currentUserId = user.userId;
          currentUserDisplayName = user.displayName;
          currentUserRole = user.role;
          localStorage.setItem('currentUserId', user.userId);
          localStorage.setItem('currentUserDisplayName', user.displayName);
          localStorage.setItem('currentUserRole', user.role);
          loginError.textContent = '';
          showDashboard();
        } else {
          loginError.textContent = 'Invalid username or password.';
        }
      }

      function handleLogout() {
        currentUserId = null;
        currentUserDisplayName = null;
        currentUserRole = null;
        localStorage.removeItem('currentUserId');
        localStorage.removeItem('currentUserDisplayName');
        localStorage.removeItem('currentUserRole');
        showPage('loginPage');
        loginUsernameInput.value = '';
        loginPasswordInput.value = '';
        createdTaskList.innerHTML = '';
        assignedTaskList.innerHTML = '';
        allTaskList.innerHTML = '';
      }

      // --- Dashboard Rendering ---
      async function showDashboard() {
        showPage('dashboardPage');
        welcomeMessage.textContent = `Welcome, ${currentUserDisplayName}!`;
        userRoleDisplay.textContent = currentUserRole;
        userRoleDisplay.className = `role-tag role-${currentUserRole.toLowerCase()}`;
        
        // Show/hide task sections based on role
        if (currentUserRole === 'Admin') {
            employeeTaskSections.classList.add('hidden');
            adminTaskSection.classList.remove('hidden');
            assignToContainer.classList.remove('hidden'); // Admins can assign tasks on creation
            assignExistingTaskForm.classList.remove('hidden'); // Admins can reassign existing tasks
            await loadAllUsersForDropdown(); // Load users for both 'Add New' and 'Reassign' dropdowns
        } else { // Employee
            employeeTaskSections.classList.remove('hidden');
            adminTaskSection.classList.add('hidden');
            assignToContainer.classList.add('hidden'); // Employees cannot assign tasks to others on creation
            assignExistingTaskForm.classList.add('hidden'); // Employees cannot reassign existing tasks
        }

        updateDashboardAndTasks(); // Initial load of data
      }

      async function loadAllUsersForDropdown() {
        // Show loading state for both dropdowns
        showLoading(true, assignToDropdown);
        showLoading(true, assignExistingToDropdown);

        google.script.run
            .withSuccessHandler(handleServerSuccess(users => {
                allUsers = users;
                
                // Populate 'Assign To' in 'Add New Task' form
                assignToDropdown.innerHTML = '';
                const selfOptionNew = document.createElement('option');
                selfOptionNew.value = currentUserId;
                selfOptionNew.textContent = `(Me) ${currentUserDisplayName}`;
                assignToDropdown.appendChild(selfOptionNew);

                // Populate 'Assign To Employee' in 'Reassign Existing Task' form
                assignExistingToDropdown.innerHTML = '';
                const pleaseSelectOption = document.createElement('option');
                pleaseSelectOption.value = '';
                pleaseSelectOption.textContent = '-- Select Employee --';
                assignExistingToDropdown.appendChild(pleaseSelectOption);

                allUsers.forEach(user => {
                    // For Add New Task dropdown (include all users for admin)
                    if (user.id !== currentUserId) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.displayName} (${user.role})`;
                        assignToDropdown.appendChild(option);
                    }

                    // For Reassign Existing Task dropdown (only employees)
                    if (user.role === 'Employee') {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.displayName}`;
                        assignExistingToDropdown.appendChild(option);
                    }
                });
                showLoading(false, assignToDropdown);
                showLoading(false, assignExistingToDropdown);
            }))
            .withFailureHandler(handleServerError('Failed to load users for assignment'))
            .getAllUsersForDropdown();
      }

      async function updateDashboardAndTasks() {
        // Show loading in all relevant task lists
        if (currentUserRole === 'Admin') {
            showLoading(true, allTaskList);
            showLoading(true, selectTaskToAssignDropdown); // Also show loading for task selection dropdown
        } else {
            showLoading(true, createdTaskList);
            showLoading(true, assignedTaskList);
        }

        // Fetch dashboard summary
        google.script.run
          .withSuccessHandler(handleServerSuccess(renderDashboardSummary))
          .withFailureHandler(handleServerError('Failed to load dashboard summary'))
          .getDashboardSummary(currentUserId, currentUserRole);

        // Fetch user's tasks
        google.script.run
          .withSuccessHandler(handleServerSuccess(renderAllTaskLists))
          .withFailureHandler(handleServerError('Failed to load tasks'))
          .getTasksForUser(currentUserId, currentUserRole);
      }

      function renderDashboardSummary(summary) {
        totalTasksCount.textContent = summary.totalTasks;
        toDoTasksCount.textContent = summary.toDoTasks;
        doneTasksCount.textContent = summary.doneTasks;
      }

      function renderAllTaskLists(taskData) {
        if (currentUserRole === 'Admin') {
            currentAdminTasks = taskData.allTasks; // Store for reassign dropdown
            renderTaskList(allTaskList, currentAdminTasks, true); // true for showing owner
            populateSelectTaskToAssignDropdown(currentAdminTasks);
        } else { // Employee
            renderTaskList(createdTaskList, taskData.createdTasks, false, "created");
            renderTaskList(assignedTaskList, taskData.assignedTasks, false, "assigned");
        }
      }

      function populateSelectTaskToAssignDropdown(tasks) {
          selectTaskToAssignDropdown.innerHTML = '';
          const pleaseSelectOption = document.createElement('option');
          pleaseSelectOption.value = '';
          pleaseSelectOption.textContent = '-- Select Task --';
          selectTaskToAssignDropdown.appendChild(pleaseSelectOption);

          tasks.forEach(task => {
              const option = document.createElement('option');
              option.value = task.id;
              option.textContent = `${task.title} (Assigned to: ${task.assignedToDisplayName})`;
              selectTaskToAssignDropdown.appendChild(option);
          });
          showLoading(false, selectTaskToAssignDropdown);
      }

      // --- Render a single Task List to UI ---
      function renderTaskList(targetListElement, tasks, showOwnerInfo = false, taskCategory = "") {
        showLoading(false, targetListElement); // Clear loading state for this specific list
        targetListElement.innerHTML = ''; // Clear existing tasks

        if (tasks.length === 0) {
          let message = 'No tasks found here.';
          if (taskCategory === "created") message = 'No tasks you have created yet!';
          if (taskCategory === "assigned") message = 'No tasks assigned to you yet!';
          targetListElement.innerHTML = `<li class="empty">${message}</li>`;
          return;
        }

        tasks.forEach(task => {
          const listItem = document.createElement('li');
          listItem.setAttribute('data-id', task.id);
          if (task.status === 'Done') {
            listItem.classList.add('done');
          }

          let ownerInfoHtml = '';
          if (showOwnerInfo) { // For Admin view
            ownerInfoHtml = `<span class="task-owner"> (Created by: ${task.createdByDisplayName} | Assigned to: ${task.assignedToDisplayName})</span>`;
          } else if (taskCategory === "assigned" && task.createdByUserId !== currentUserId) { // For Employee assigned tasks, show who created it if not self
              ownerInfoHtml = `<span class="task-owner"> (Created by: ${task.createdByDisplayName})</span>`;
          }


          listItem.innerHTML = `
            <div class="task-content">
              <h3>${task.title} ${ownerInfoHtml}</h3>
              <p>${task.description || 'No description'}</p>
              <small>Status: ${task.status} | Created: ${task.createdAt}
              ${task.status === 'Done' && task.completedAt ? `| Completed: ${task.completedAt}` : ''}
              </small>
            </div>
            <div class="task-actions">
              <button class="toggle-status-btn" data-status="${task.status}">
                ${task.status === 'To Do' ? 'Mark Done' : 'Mark To Do'}
              </button>
              <button class="delete-btn">Delete</button>
            </div>
          `;
          targetListElement.appendChild(listItem);
        });
        attachTaskEventListeners(targetListElement);
      }

      // --- Attach Event Listeners to Dynamically Created Task Elements ---
      function attachTaskEventListeners(listElement) {
        listElement.querySelectorAll('.toggle-status-btn').forEach(button => {
            button.onclick = function() {
                const taskId = this.closest('li').dataset.id;
                const currentStatus = this.dataset.status;
                const newStatus = currentStatus === 'To Do' ? 'Done' : 'To Do';
                
                // Show loading for ALL relevant lists to ensure full refresh
                if (currentUserRole === 'Admin') {
                    showLoading(true, allTaskList);
                } else {
                    showLoading(true, createdTaskList);
                    showLoading(true, assignedTaskList);
                }
                
                google.script.run
                    .withSuccessHandler(handleServerSuccess(renderAllTaskLists))
                    .withFailureHandler(handleServerError('Failed to update task status'))
                    .updateTaskStatus(taskId, newStatus, currentUserId, currentUserRole);
            };
        });

        listElement.querySelectorAll('.delete-btn').forEach(button => {
            button.onclick = function() {
                if (confirm('Are you sure you want to delete this task?')) {
                    const taskId = this.closest('li').dataset.id;
                    
                    // Show loading for ALL relevant lists to ensure full refresh
                    if (currentUserRole === 'Admin') {
                        showLoading(true, allTaskList);
                    } else {
                        showLoading(true, createdTaskList);
                        showLoading(true, assignedTaskList);
                    }
                    
                    google.script.run
                        .withSuccessHandler(handleServerSuccess(renderAllTaskLists))
                        .withFailureHandler(handleServerError('Failed to delete task'))
                        .deleteTask(taskId, currentUserId, currentUserRole);
                }
            };
        });
      }


      // --- Main Event Listeners ---
      loginBtn.onclick = function() {
        const username = loginUsernameInput.value.trim();
        const password = loginPasswordInput.value.trim();

        if (!username || !password) {
          loginError.textContent = 'Please enter both username and password.';
          return;
        }

        loginBtn.disabled = true;
        loginError.textContent = 'Logging in...';

        google.script.run
          .withSuccessHandler(handleServerSuccess(handleLoginSuccess))
          .withFailureHandler(handleServerError('Login failed'))
          .authenticateUser(username, password);
      };

      logoutBtn.onclick = handleLogout;

      addTaskBtn.onclick = function() {
        const title = taskTitleInput.value.trim();
        const description = taskDescriptionInput.value.trim();
        let assignedToId = currentUserId; // Default to self

        if (currentUserRole === 'Admin') {
            assignedToId = assignToDropdown.value; // Get selected user if Admin
        }

        if (!title) {
          alert('Task title cannot be empty.');
          return;
        }

        // Show loading for ALL relevant lists to ensure full refresh
        if (currentUserRole === 'Admin') {
            showLoading(true, allTaskList);
        } else {
            showLoading(true, createdTaskList);
            showLoading(true, assignedTaskList);
        }

        google.script.run
          .withSuccessHandler(handleServerSuccess((updatedTaskData) => {
            taskTitleInput.value = '';
            taskDescriptionInput.value = '';
            // No need to clear dropdowns for add new task, it defaults to self or previously selected.
            renderAllTaskLists(updatedTaskData);
            updateDashboardAndTasks(); // Refresh summary and task dropdowns
            showStatusMessage(addTaskMessage, 'Task added successfully!', true);
          }))
          .withFailureHandler(handleServerError('Failed to add task', addTaskMessage))
          .addTask({ title: title, description: description }, currentUserId, currentUserRole, assignedToId);
      };

      // NEW: Assign Existing Task Button Listener
      assignExistingTaskBtn.onclick = function() {
          const taskId = selectTaskToAssignDropdown.value;
          const newAssignedToUserId = assignExistingToDropdown.value;

          if (!taskId) {
              showStatusMessage(assignExistingTaskMessage, 'Please select a task to assign.', false);
              return;
          }
          if (!newAssignedToUserId) {
              showStatusMessage(assignExistingTaskMessage, 'Please select an employee to assign the task to.', false);
              return;
          }
          
          assignExistingTaskBtn.disabled = true;
          // Show loading for ALL relevant lists to ensure full refresh
          if (currentUserRole === 'Admin') {
            showLoading(true, allTaskList);
          } else {
            showLoading(true, createdTaskList);
            showLoading(true, assignedTaskList);
          }
          
          google.script.run
              .withSuccessHandler(handleServerSuccess((updatedTaskData) => {
                  renderAllTaskLists(updatedTaskData);
                  updateDashboardAndTasks(); // Re-fetch summary and dropdowns
                  showStatusMessage(assignExistingTaskMessage, 'Task reassigned successfully!', true);
                  assignExistingTaskBtn.disabled = false;
                  selectTaskToAssignDropdown.value = ''; // Clear selection
                  assignExistingToDropdown.value = ''; // Clear selection
              }))
              .withFailureHandler(handleServerError('Failed to reassign task', assignExistingTaskMessage))
              .assignExistingTask(taskId, newAssignedToUserId, currentUserId, currentUserRole);
      };


      // --- Initial Load ---
      document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
  </body>
</html>
